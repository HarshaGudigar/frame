name: Test Suite

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    test-backend:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./backend
        steps:
            - uses: actions/checkout@v4

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22.x'
                  cache: 'npm'
                  cache-dependency-path: package-lock.json

            - name: Install Dependencies
              run: npm ci --ignore-scripts

            - name: Run Backend Tests
              run: npm test
              env:
                  NODE_ENV: test
                  JWT_SECRET: test-secret
                  HEARTBEAT_SECRET: test-heartbeat
                  MONGODB_URI: memory # Handled by mongodb-memory-server, but good to be explicit

    test-frontend:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./frontend
        steps:
            - uses: actions/checkout@v4

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22.x'
                  cache: 'npm'
                  cache-dependency-path: package-lock.json

            - name: Install Dependencies
              run: npm ci --ignore-scripts

            - name: Run Frontend Tests
              run: npm test

    build-docker:
        runs-on: ubuntu-latest
        needs: [test-backend, test-frontend]
        steps:
            - uses: actions/checkout@v4

            - name: Build monolithic Docker image
              run: docker build -t frame-app:ci .

            - name: Start container
              run: |
                  docker run -d --name frame-ci \
                      -e JWT_SECRET=ci-test \
                      -e HEARTBEAT_SECRET=ci-test \
                      -e RESEND_API_KEY=re_ci_test \
                      -e NODE_ENV=production \
                      -p 3000:3000 -p 5000:5000 \
                      frame-app:ci

            - name: Wait for health endpoint
              run: |
                  echo "Waiting for container to be ready..."
                  for i in $(seq 1 24); do
                      if curl -sf http://localhost:5000/api/health > /dev/null 2>&1; then
                          echo "Health endpoint is up (attempt $i)"
                          exit 0
                      fi
                      echo "  Attempt $i/24 â€” not ready yet"
                      sleep 5
                  done
                  echo "Container failed to become healthy within 120s"
                  docker logs frame-ci
                  exit 1

            - name: Integration tests
              run: |
                  # Health endpoint returns 200 with "connected" database status
                  HEALTH=$(curl -sf http://localhost:5000/api/health)
                  echo "Health response: $HEALTH"
                  echo "$HEALTH" | grep -q '"status":"connected"'

                  # Frontend returns 200
                  curl -sf -o /dev/null -w "%{http_code}" http://localhost:3000/ | grep -q "200"

                  echo "All integration tests passed."

            - name: Cleanup
              if: always()
              run: |
                  docker stop frame-ci 2>/dev/null || true
                  docker rm frame-ci 2>/dev/null || true
