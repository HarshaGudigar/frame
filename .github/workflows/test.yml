name: Test Suite

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    test-backend:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./backend
        steps:
            - uses: actions/checkout@v4

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22.x'
                  cache: 'npm'
                  cache-dependency-path: backend/package-lock.json

            - name: Install Dependencies
              run: npm ci

            - name: Run Backend Tests
              run: npm test
              env:
                  NODE_ENV: test
                  JWT_SECRET: test-secret
                  HEARTBEAT_SECRET: test-heartbeat
                  MONGODB_URI: memory # Handled by mongodb-memory-server, but good to be explicit

    test-frontend:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./frontend
        steps:
            - uses: actions/checkout@v4

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22.x'
                  cache: 'npm'
                  cache-dependency-path: frontend/package-lock.json

            - name: Install Dependencies
              run: npm ci

            - name: Run Frontend Tests
              run: npm test

    build-docker:
        runs-on: ubuntu-latest
        needs: [test-backend, test-frontend]
        steps:
            - uses: actions/checkout@v4

            - name: Build and Start Services
              run: |
                  # Create a dummy .env for backend to pass health check if needed
                  echo "JWT_SECRET=ci-test" >> backend/.env
                  echo "HEARTBEAT_SECRET=ci-test" >> backend/.env
                  echo "RESEND_API_KEY=re_ci_test" >> backend/.env

                  docker compose up -d --build

            - name: Wait for services to be ready
              run: |
                  echo "Waiting for services to be ready..."
                  for i in $(seq 1 24); do
                      B_STATUS=$(docker inspect --format='{{.State.Health.Status}}' frame-backend 2>/dev/null || echo "unknown")
                      F_STATUS=$(docker inspect --format='{{.State.Health.Status}}' frame-frontend 2>/dev/null || echo "unknown")
                      M_STATUS=$(docker inspect --format='{{.State.Health.Status}}' frame-mongo 2>/dev/null || echo "unknown")
                      
                      echo "  Attempt $i: Backend=$B_STATUS, Frontend=$F_STATUS, Mongo=$M_STATUS"
                      
                      if [ "$B_STATUS" = "healthy" ] && [ "$F_STATUS" = "healthy" ]; then
                          echo "Core services are healthy!"
                          exit 0
                      fi
                      sleep 5
                  done
                  echo "Services failed to become healthy"
                  docker compose logs
                  exit 1

            - name: Integration tests
              run: |
                  # Health endpoint returns 200 with "connected" database status
                  HEALTH=$(curl -sf http://localhost:5000/api/health)
                  echo "Health response: $HEALTH"
                  echo "$HEALTH" | grep -q '"status":"connected"'

                  # Frontend returns 200
                  curl -sf -o /dev/null -w "%{http_code}" http://localhost:3000/ | grep -q "200"

                  echo "All integration tests passed."

            - name: Cleanup
              if: always()
              run: docker compose down -v
