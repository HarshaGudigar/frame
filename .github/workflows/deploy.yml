name: Deploy to Lightsail

on:
    push:
        branches:
            - main
    workflow_dispatch:
        inputs:
            target_host:
                description: 'Target VM IP'
                required: false
                default: ''

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Determine Target Host
              id: set-host
              run: |
                  if [ "${{ github.event.inputs.target_host }}" != "" ]; then
                    echo "host=${{ github.event.inputs.target_host }}" >> $GITHUB_OUTPUT
                  else
                    echo "host=${{ secrets.LIGHTSAIL_HOST }}" >> $GITHUB_OUTPUT
                  fi

            - name: Deploy via SSH with rollback
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ steps.set-host.outputs.host }}
                  username: ${{ secrets.LIGHTSAIL_USERNAME }}
                  key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
                  timeout: 60m
                  script: |
                      set -e

                      # Navigate to project or clone it
                      cd ~/frame || git clone https://github.com/${{ github.repository }} ~/frame
                      cd ~/frame

                      # Snapshot current running image as rollback
                      sudo docker tag frame-app:latest frame-app:rollback 2>/dev/null || true

                      # Pull latest code and rebuild
                      git pull origin main
                      sudo docker builder prune -af
                      sudo docker compose down --remove-orphans
                      sudo docker compose up -d --build --remove-orphans

                      # Wait for health check — initial sleep matches Docker start-period,
                      # then poll every 10s for up to 600s (60 attempts)
                      echo "Waiting for container to become healthy..."
                      sleep 90
                      HEALTHY=false
                      for i in $(seq 1 60); do
                          STATUS=$(sudo docker inspect --format='{{.State.Health.Status}}' frame-app 2>/dev/null || echo "unknown")
                          echo "  Attempt $i/60: status=$STATUS"
                          if [ "$STATUS" = "healthy" ]; then
                              HEALTHY=true
                              break
                          fi
                          sleep 10
                      done

                      if [ "$HEALTHY" = "true" ]; then
                          echo "Deployment successful — container is healthy."
                          sudo docker rmi frame-app:rollback 2>/dev/null || true
                      else
                          echo "Deployment FAILED — container did not become healthy within the wait period."
                          echo "Reporting container logs for diagnostics:"
                          sudo docker logs frame-app --tail 100
                          echo "Rolling back to previous image..."
                          sudo docker compose down
                          sudo docker tag frame-app:rollback frame-app:latest 2>/dev/null || true
                          sudo docker compose up -d
                          sudo docker rmi frame-app:rollback 2>/dev/null || true
                          exit 1
                      fi
