name: Deploy to Lightsail

on:
    push:
        branches:
            - main
    workflow_dispatch:
        inputs:
            target_host:
                description: 'Target VM IP'
                required: false
                default: ''

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Determine Target Host
              id: set-host
              run: |
                  if [ "${{ github.event.inputs.target_host }}" != "" ]; then
                    echo "host=${{ github.event.inputs.target_host }}" >> $GITHUB_OUTPUT
                  else
                    echo "host=${{ secrets.LIGHTSAIL_HOST }}" >> $GITHUB_OUTPUT
                  fi

            - name: Validate required secrets
              env:
                  CHECK_JWT_SECRET: ${{ secrets.PROD_JWT_SECRET }}
                  CHECK_REFRESH_SECRET: ${{ secrets.PROD_REFRESH_TOKEN_SECRET }}
                  CHECK_HEARTBEAT_SECRET: ${{ secrets.PROD_HEARTBEAT_SECRET }}
                  CHECK_RESEND_KEY: ${{ secrets.PROD_RESEND_API_KEY }}
                  CHECK_MONGODB_URI: ${{ secrets.PROD_MONGODB_URI }}
                  CHECK_INSTANCE_NAME: ${{ secrets.PROD_INSTANCE_NAME }}
              run: |
                  MISSING=()
                  [ -z "$CHECK_JWT_SECRET" ]       && MISSING+=("PROD_JWT_SECRET")
                  [ -z "$CHECK_REFRESH_SECRET" ]   && MISSING+=("PROD_REFRESH_TOKEN_SECRET")
                  [ -z "$CHECK_HEARTBEAT_SECRET" ] && MISSING+=("PROD_HEARTBEAT_SECRET")
                  [ -z "$CHECK_RESEND_KEY" ]        && MISSING+=("PROD_RESEND_API_KEY")
                  [ -z "$CHECK_MONGODB_URI" ]       && MISSING+=("PROD_MONGODB_URI")
                  [ -z "$CHECK_INSTANCE_NAME" ]     && MISSING+=("PROD_INSTANCE_NAME")
                  if [ ${#MISSING[@]} -gt 0 ]; then
                    echo "❌ The following required GitHub Secrets are not set:"
                    for s in "${MISSING[@]}"; do echo "   • $s"; done
                    echo ""
                    echo "Go to: GitHub → Settings → Secrets and variables → Actions"
                    exit 1
                  fi
                  echo "✅ All required secrets are present."

            - name: Write production .env on server
              uses: appleboy/ssh-action@v1.0.3

              env:
                  PROD_INSTANCE_NAME: ${{ secrets.PROD_INSTANCE_NAME }}
                  PROD_INSTANCE_SLUG: ${{ secrets.PROD_INSTANCE_SLUG }}
                  PROD_INSTANCE_DESCRIPTION: ${{ secrets.PROD_INSTANCE_DESCRIPTION }}
                  PROD_MONGODB_URI: ${{ secrets.PROD_MONGODB_URI }}
                  PROD_JWT_SECRET: ${{ secrets.PROD_JWT_SECRET }}
                  PROD_JWT_EXPIRY: ${{ secrets.PROD_JWT_EXPIRY }}
                  PROD_REFRESH_TOKEN_SECRET: ${{ secrets.PROD_REFRESH_TOKEN_SECRET }}
                  PROD_REFRESH_TOKEN_EXPIRY: ${{ secrets.PROD_REFRESH_TOKEN_EXPIRY }}
                  PROD_HEARTBEAT_SECRET: ${{ secrets.PROD_HEARTBEAT_SECRET }}
                  PROD_RESEND_API_KEY: ${{ secrets.PROD_RESEND_API_KEY }}
                  PROD_APP_URL: ${{ secrets.PROD_APP_URL }}
                  PROD_EMAIL_FROM: ${{ secrets.PROD_EMAIL_FROM }}
                  PROD_CORS_ORIGINS: ${{ secrets.PROD_CORS_ORIGINS }}
                  PROD_AWS_REGION: ${{ secrets.PROD_AWS_REGION }}
                  PROD_AWS_ACCESS_KEY_ID: ${{ secrets.PROD_AWS_ACCESS_KEY_ID }}
                  PROD_AWS_SECRET_ACCESS_KEY: ${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}
                  PROD_BEDROCK_MODEL_ID: ${{ secrets.PROD_BEDROCK_MODEL_ID }}
              with:
                  host: ${{ steps.set-host.outputs.host }}
                  username: ${{ secrets.LIGHTSAIL_USERNAME }}
                  key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
                  timeout: 5m
                  envs: PROD_INSTANCE_NAME,PROD_INSTANCE_SLUG,PROD_INSTANCE_DESCRIPTION,PROD_MONGODB_URI,PROD_JWT_SECRET,PROD_JWT_EXPIRY,PROD_REFRESH_TOKEN_SECRET,PROD_REFRESH_TOKEN_EXPIRY,PROD_HEARTBEAT_SECRET,PROD_RESEND_API_KEY,PROD_APP_URL,PROD_EMAIL_FROM,PROD_CORS_ORIGINS,PROD_AWS_REGION,PROD_AWS_ACCESS_KEY_ID,PROD_AWS_SECRET_ACCESS_KEY,PROD_BEDROCK_MODEL_ID
                  script: |
                      mkdir -p ~/frame/backend
                      cat > ~/frame/backend/.env << ENVEOF
                      NODE_ENV=production
                      PORT=5000

                      # ─── Branding ──────────────────────────────────────
                      INSTANCE_NAME="${PROD_INSTANCE_NAME}"
                      INSTANCE_SLUG="${PROD_INSTANCE_SLUG}"
                      INSTANCE_DESCRIPTION="${PROD_INSTANCE_DESCRIPTION}"

                      # ─── Database ──────────────────────────────────────
                      MONGODB_URI="${PROD_MONGODB_URI}"

                      # ─── Auth ──────────────────────────────────────────
                      JWT_SECRET="${PROD_JWT_SECRET}"
                      JWT_EXPIRY="${PROD_JWT_EXPIRY:-15m}"
                      REFRESH_TOKEN_SECRET="${PROD_REFRESH_TOKEN_SECRET}"
                      REFRESH_TOKEN_EXPIRY="${PROD_REFRESH_TOKEN_EXPIRY:-7d}"

                      # ─── Fleet Manager ─────────────────────────────────
                      HEARTBEAT_SECRET="${PROD_HEARTBEAT_SECRET}"

                      # ─── Email ─────────────────────────────────────────
                      RESEND_API_KEY="${PROD_RESEND_API_KEY}"
                      APP_URL="${PROD_APP_URL}"
                      EMAIL_FROM="${PROD_EMAIL_FROM}"

                      # ─── CORS ──────────────────────────────────────────
                      CORS_ORIGINS="${PROD_CORS_ORIGINS}"

                      # ─── AI (AWS Bedrock) ──────────────────────────────
                      AWS_REGION="${PROD_AWS_REGION}"
                      AWS_ACCESS_KEY_ID="${PROD_AWS_ACCESS_KEY_ID}"
                      AWS_SECRET_ACCESS_KEY="${PROD_AWS_SECRET_ACCESS_KEY}"
                      BEDROCK_MODEL_ID="${PROD_BEDROCK_MODEL_ID}"
                      ENVEOF
                      echo ".env written successfully."

            - name: Deploy via SSH with rollback
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ steps.set-host.outputs.host }}
                  username: ${{ secrets.LIGHTSAIL_USERNAME }}
                  key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
                  timeout: 60m
                  command_timeout: 30m
                  script: |
                      set -e

                      # Navigate to project or clone it
                      cd ~/frame || git clone https://github.com/${{ github.repository }} ~/frame
                      cd ~/frame

                      # Snapshot current running image as rollback
                      sudo docker tag frame-app:latest frame-app:rollback 2>/dev/null || true

                      # Pull latest code and rebuild
                      git pull origin main
                      sudo docker builder prune -af
                      sudo docker compose down --remove-orphans
                      sudo docker compose up -d --build --remove-orphans

                      # Wait for health check — initial sleep matches Docker start-period,
                      # then poll every 10s for up to 600s (60 attempts)
                      echo "Waiting for container to become healthy..."
                      sleep 90
                      HEALTHY=false
                      for i in $(seq 1 60); do
                          STATUS=$(sudo docker inspect --format='{{.State.Health.Status}}' frame-app 2>/dev/null || echo "unknown")
                          echo "  Attempt $i/60: status=$STATUS"
                          if [ "$STATUS" = "healthy" ]; then
                              HEALTHY=true
                              break
                          fi
                          sleep 10
                      done

                      if [ "$HEALTHY" = "true" ]; then
                          echo "Deployment successful — container is healthy."
                          sudo docker rmi frame-app:rollback 2>/dev/null || true
                      else
                          echo "Deployment FAILED — container did not become healthy within the wait period."
                          echo "Reporting container logs for diagnostics:"
                          sudo docker logs frame-app --tail 100
                          echo "Rolling back to previous image..."
                          sudo docker compose down
                          sudo docker tag frame-app:rollback frame-app:latest 2>/dev/null || true
                          sudo docker compose up -d
                          sudo docker rmi frame-app:rollback 2>/dev/null || true
                          exit 1
                      fi
