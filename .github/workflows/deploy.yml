name: Deploy to Lightsail

on:
    push:
        branches:
            - main
    workflow_dispatch:
        inputs:
            target_host:
                description: 'Target VM IP'
                required: false
                default: ''

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Determine Target Host
              id: set-host
              run: |
                  if [ "${{ github.event.inputs.target_host }}" != "" ]; then
                    echo "host=${{ github.event.inputs.target_host }}" >> $GITHUB_OUTPUT
                  else
                    echo "host=${{ secrets.LIGHTSAIL_HOST }}" >> $GITHUB_OUTPUT
                  fi

            - name: Deploy via SSH with rollback
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ steps.set-host.outputs.host }}
                  username: ${{ secrets.LIGHTSAIL_USERNAME }}
                  key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
                  script: |
                      set -e

                      # Navigate to project or clone it
                      cd ~/frame || git clone https://github.com/${{ github.repository }} ~/frame
                      cd ~/frame

                      # Snapshot current running images as rollback
                      sudo docker tag frame-backend:latest frame-backend:rollback 2>/dev/null || true
                      sudo docker tag frame-frontend:latest frame-frontend:rollback 2>/dev/null || true

                      # Pull latest code and rebuild
                      git pull origin main
                      sudo docker builder prune -af
                      sudo docker compose down --remove-orphans
                      sudo docker compose up -d --build --remove-orphans

                      # Wait for health check (poll every 5s, max 12 attempts = 60s)
                      echo "Waiting for services to become healthy..."
                      HEALTHY=false
                      for i in $(seq 1 12); do
                          B_STATUS=$(sudo docker inspect --format='{{.State.Health.Status}}' frame-backend 2>/dev/null || echo "unknown")
                          F_STATUS=$(sudo docker inspect --format='{{.State.Health.Status}}' frame-frontend 2>/dev/null || echo "unknown")
                          
                          echo "  Attempt $i/12: backend=$B_STATUS, frontend=$F_STATUS"
                          
                          if [ "$B_STATUS" = "healthy" ] && [ "$F_STATUS" = "healthy" ]; then
                              HEALTHY=true
                              break
                          fi
                          sleep 5
                      done

                      if [ "$HEALTHY" = "true" ]; then
                          echo "Deployment successful — services are healthy."
                          # Clean up rollback images on success
                          sudo docker rmi frame-backend:rollback frame-frontend:rollback 2>/dev/null || true
                      else
                          echo "Deployment FAILED — services did not become healthy within 60s."
                          echo "Rolling back..."
                          sudo docker compose down
                          sudo docker tag frame-backend:rollback frame-backend:latest 2>/dev/null || true
                          sudo docker tag frame-frontend:rollback frame-frontend:latest 2>/dev/null || true
                          sudo docker compose up -d
                          sudo docker rmi frame-backend:rollback frame-frontend:rollback 2>/dev/null || true
                          exit 1
                      fi
