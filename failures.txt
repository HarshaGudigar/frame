  â— Phase 2 Completion Verification â€º Dependency Validation â€º should reject purchase if dependencies are missing

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 500

    [0m [90m 86 |[39m                 [33m.[39msend({ tenantId[33m:[39m tenant[33m.[39m_id[33m.[39mtoString()[33m,[39m productId[33m:[39m billing[33m.[39m_id[33m.[39mtoString() })[33m;[39m
     [90m 87 |[39m
    [31m[1m>[22m[39m[90m 88 |[39m             expect(res[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m    |[39m                                [31m[1m^[22m[39m
     [90m 89 |[39m             expect(res[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'Missing required dependencies: crm'[39m)[33m;[39m
     [90m 90 |[39m         })[33m;[39m
     [90m 91 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (tests/phase2_completion.test.js:88:32)

  â— Phase 2 Completion Verification â€º Tenant Lifecycle & Suspension â€º should export tenant data (Owner only)

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 114 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${ownerToken}`[39m)[33m;[39m
     [90m 115 |[39m
    [31m[1m>[22m[39m[90m 116 |[39m             expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 117 |[39m             expect(res[33m.[39mbody[33m.[39mtenant[33m.[39mslug)[33m.[39mtoBe([32m'export-tenant'[39m)[33m;[39m
     [90m 118 |[39m             expect(res[33m.[39mbody[33m.[39mexportedAt)[33m.[39mtoBeDefined()[33m;[39m
     [90m 119 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/phase2_completion.test.js:116:32)

  â— Phase 2 Completion Verification â€º Usage Tracking â€º should meter API calls via usageMiddleware

    TypeError: next is not a function

    [0m [90m 33 |[39m         [90m// Note: If there's NO store or NO tenant, we assume it's a global operation[39m
     [90m 34 |[39m         [90m// (like a fleet manager job). In a stricter environment, we could throw an error here.[39m
    [31m[1m>[22m[39m[90m 35 |[39m         next()[33m;[39m
     [90m    |[39m         [31m[1m^[22m[39m
     [90m 36 |[39m     }[33m;[39m
     [90m 37 |[39m
     [90m 38 |[39m     [90m// Apply hook to all standard find operations[39m[0m

      at model.Query.enforceTenantIsolation (plugins/tenantPlugin.js:35:9)
      at Kareem.execPre (../node_modules/kareem/index.js:68:39)
      at _executePreHooks (../node_modules/mongoose/lib/query.js:4745:33)
      at model.Query.exec (../node_modules/mongoose/lib/query.js:4686:11)
      at Object.<anonymous> (tests/phase2_completion.test.js:139:27)

FAIL tests/provisioning.test.js
  Provisioning Engine
    Ã— should call onProvision hook and emit socket event on purchase (388 ms)
--
  â— Provisioning Engine â€º should call onProvision hook and emit socket event on purchase

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 72 |[39m
     [90m 73 |[39m         [90m// 5. Assertions[39m
    [31m[1m>[22m[39m[90m 74 |[39m         expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m    |[39m                            [31m[1m^[22m[39m
     [90m 75 |[39m         expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 76 |[39m
     [90m 77 |[39m         [90m// Verify onProvision was called with the tenant object[39m[0m

      at Object.<anonymous> (tests/provisioning.test.js:74:28)

  â— Provisioning Engine â€º should not fail purchase if onProvision hook fails

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 123 |[39m
     [90m 124 |[39m         [90m// Assertions: Purchase should still succeed[39m
    [31m[1m>[22m[39m[90m 125 |[39m         expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 126 |[39m         expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 127 |[39m         expect(onProvisionSpy)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m 128 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (tests/provisioning.test.js:125:28)

PASS tests/two-factor.test.js (14.804 s)
  Two-Factor Authentication
    GET /api/auth/2fa/status
      âˆš should return isTwoFactorEnabled: false by default (349 ms)
