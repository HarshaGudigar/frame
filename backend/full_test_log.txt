
> backend@1.0.0 test
> jest --runInBand

FAIL tests/metrics.test.js
  Analytics & Metrics
    âˆš should create a metric record on heartbeat (30 ms)
    Ã— should retrieve historical metrics (11 ms)
    Ã— should retrieve fleet statistics (9 ms)

  â— Analytics & Metrics â€º should retrieve historical metrics

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 69 |[39m             [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${adminToken}`[39m)[33m;[39m
     [90m 70 |[39m
    [31m[1m>[22m[39m[90m 71 |[39m         expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m    |[39m                                [31m[1m^[22m[39m
     [90m 72 |[39m         expect(res[33m.[39mbody[33m.[39mdata[33m.[39mlength)[33m.[39mtoBeGreaterThan([35m0[39m)[33m;[39m
     [90m 73 |[39m         expect(res[33m.[39mbody[33m.[39mdata[[35m0[39m][33m.[39mmetrics[33m.[39mcpu)[33m.[39mtoBe([35m45[39m)[33m;[39m
     [90m 74 |[39m     })[33m;[39m[0m

      at Object.toBe (tests/metrics.test.js:71:32)

  â— Analytics & Metrics â€º should retrieve fleet statistics

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 79 |[39m             [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${adminToken}`[39m)[33m;[39m
     [90m 80 |[39m
    [31m[1m>[22m[39m[90m 81 |[39m         expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m    |[39m                                [31m[1m^[22m[39m
     [90m 82 |[39m         expect(res[33m.[39mbody[33m.[39mdata[33m.[39mtotal)[33m.[39mtoBeGreaterThan([35m0[39m)[33m;[39m
     [90m 83 |[39m         expect(res[33m.[39mbody[33m.[39mdata[33m.[39maverages[33m.[39mavgCpu)[33m.[39mtoBe([35m45[39m)[33m;[39m
     [90m 84 |[39m     })[33m;[39m[0m

      at Object.toBe (tests/metrics.test.js:81:32)

PASS tests/admin.test.js
  POST /api/admin/tenants
    âˆš should create a tenant (332 ms)
    âˆš should reject duplicate slug with 409 (277 ms)
    âˆš should reject missing name (Zod) (261 ms)
    âˆš should reject invalid slug format (260 ms)
    âˆš should require auth (254 ms)
  GET /api/admin/tenants
    âˆš should list all tenants (289 ms)
    âˆš should return empty array when no tenants (258 ms)
  GET /api/admin/tenants/:id
    âˆš should get a specific tenant (271 ms)
    âˆš should return 404 for nonexistent ID (258 ms)
    âˆš should reject invalid ID format (255 ms)
  PUT /api/admin/tenants/:id
    âˆš should update a tenant (275 ms)
  DELETE /api/admin/tenants/:id
    âˆš should delete a tenant (284 ms)

PASS tests/marketplace.test.js
  GET /api/marketplace/products
    âˆš should list products (empty initially) (318 ms)
  POST /api/marketplace/products
    âˆš should create a product (266 ms)
    âˆš should reject duplicate slug with 409 (285 ms)
    âˆš should reject missing required fields (Zod) (271 ms)
    âˆš should require auth (256 ms)
  POST /api/marketplace/purchase
    âˆš should require auth (253 ms)
    âˆš should require tenant context for role check (496 ms)
    âˆš should reject empty body (Zod) (257 ms)

PASS tests/auth.test.js
  POST /api/auth/register
    âˆš should register a new user and return access + refresh tokens (297 ms)
  POST /api/auth/login
    âˆš should login and return access + refresh tokens (482 ms)
  POST /api/auth/refresh-token
    âˆš should refresh token pair with valid refresh token (264 ms)
    âˆš should reject invalid refresh token (254 ms)
    âˆš should reject reused (revoked) refresh token (270 ms)
  POST /api/auth/logout
    âˆš should revoke refresh token on logout (258 ms)
    âˆš should not allow refresh after logout (267 ms)

(node:31688) [MONGOOSE] Warning: mongoose: the `new` option for `findOneAndUpdate()` and `findOneAndReplace()` is deprecated. Use `returnDocument: 'after'` instead.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:31688) [MONGOOSE] Warning: mongoose: the `new` option for `findOneAndUpdate()` and `findOneAndReplace()` is deprecated. Use `returnDocument: 'after'` instead.
PASS tests/rbac.test.js
  RBAC & User Management
    GET /api/admin/users
      âˆš should allow owner to list users (17 ms)
      âˆš should deny access to admin (Owner only route) (12 ms)
      âˆš should deny access to staff (10 ms)
    POST /api/admin/users/invite
      âˆš should allow admin to invite new user (237 ms)
      âˆš should deny staff from inviting users (10 ms)
    DELETE /api/admin/users/:id
      âˆš should allow owner to deactivate user (19 ms)
      âˆš should prevent deleting yourself (11 ms)
    PATCH /api/admin/users/:id/role
      âˆš should allow owner to update a user role (18 ms)
      âˆš should deny role update by admin (Owner only) (12 ms)
      âˆš should prevent changing your own role (13 ms)

PASS tests/health.test.js
  Health Check
    GET /api/health
      âˆš should return 200 OK and health status (24 ms)

Test Suites: 1 failed, 5 passed, 6 total
Tests:       2 failed, 39 passed, 41 total
Snapshots:   0 total
Time:        14.701 s, estimated 15 s
Ran all test suites.
