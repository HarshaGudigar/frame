
> backend@1.0.0 test
> jest --runInBand

FAIL tests/invite.test.js (9.5 s)
  Email-Based Invite Flow
    POST /api/admin/users/invite
      Ã— should create an inactive user without a password (527 ms)
      âˆš should create an invite token (318 ms)
      âˆš should set invitedBy to the inviting user (333 ms)
      âˆš should not return a tempPassword in the response (300 ms)
      âˆš should reject duplicate email (323 ms)
    POST /api/auth/accept-invite
      âˆš should accept invite with valid token and password (562 ms)
      âˆš should activate the user account (560 ms)
      âˆš should allow login with the new password (810 ms)
      âˆš should consume the invite token (559 ms)
      âˆš should reject already-used invite token (581 ms)
      âˆš should reject invalid token (320 ms)
      âˆš should reject mismatched passwords (322 ms)
      âˆš should reject password too short (330 ms)
      âˆš should reject expired invite token (328 ms)
      âˆš should preserve the assigned role (568 ms)
    Invited user cannot login before accepting
      âˆš should reject login for user without password (336 ms)

  â— Email-Based Invite Flow â€º POST /api/admin/users/invite â€º should create an inactive user without a password

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

    [0m [90m 55 |[39m                 [32m'+password'[39m[33m,[39m
     [90m 56 |[39m             )[33m;[39m
    [31m[1m>[22m[39m[90m 57 |[39m             expect(user[33m.[39misActive)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m    |[39m                                   [31m[1m^[22m[39m
     [90m 58 |[39m             expect(user[33m.[39misEmailVerified)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 59 |[39m             expect(user[33m.[39mpassword)[33m.[39mtoBeUndefined()[33m;[39m
     [90m 60 |[39m         })[33m;[39m[0m

      at Object.toBe (tests/invite.test.js:57:35)

FAIL tests/admin.test.js (5.005 s)
  POST /api/admin/tenants
    âˆš should create a tenant (438 ms)
    âˆš should reject duplicate slug with 409 (333 ms)
    âˆš should reject missing name (Zod) (293 ms)
    âˆš should reject invalid slug format (306 ms)
    âˆš should require auth (289 ms)
  GET /api/admin/tenants
    Ã— should list all tenants (377 ms)
    âˆš should return empty array when no tenants (298 ms)
  GET /api/admin/tenants/:id
    âˆš should get a specific tenant (342 ms)
    âˆš should return 404 for nonexistent ID (291 ms)
    âˆš should reject invalid ID format (287 ms)
  PUT /api/admin/tenants/:id
    âˆš should update a tenant (338 ms)
  DELETE /api/admin/tenants/:id
    âˆš should delete a tenant (370 ms)

  â— GET /api/admin/tenants â€º should list all tenants

    expect(received).toHaveLength(expected)

    Expected length: 2
    Received length: 0
    Received array:  []

    [0m [90m 100 |[39m
     [90m 101 |[39m         expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 102 |[39m         expect(res[33m.[39mbody[33m.[39mdata)[33m.[39mtoHaveLength([35m2[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 103 |[39m     })[33m;[39m
     [90m 104 |[39m
     [90m 105 |[39m     it([32m'should return empty array when no tenants'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.toHaveLength (tests/admin.test.js:102:31)

(node:9896) [MONGOOSE] Warning: mongoose: the `new` option for `findOneAndUpdate()` and `findOneAndReplace()` is deprecated. Use `returnDocument: 'after'` instead.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:9896) [MONGOOSE] Warning: mongoose: the `new` option for `findOneAndUpdate()` and `findOneAndReplace()` is deprecated. Use `returnDocument: 'after'` instead.
FAIL tests/rbac.test.js
  RBAC & User Management
    GET /api/admin/users
      âˆš should allow owner to list users (18 ms)
      Ã— should deny access to admin (Owner only route) (15 ms)
      âˆš should deny access to staff (14 ms)
    POST /api/admin/users/invite
      âˆš should allow admin to invite new user (30 ms)
      âˆš should deny staff from inviting users (14 ms)
    DELETE /api/admin/users/:id
      âˆš should allow owner to deactivate user (28 ms)
      âˆš should prevent deleting yourself (15 ms)
    PATCH /api/admin/users/:id/role
      âˆš should allow owner to update a user role (30 ms)
      âˆš should deny role update by admin (Owner only) (18 ms)
      âˆš should prevent changing your own role (21 ms)

  â— RBAC & User Management â€º GET /api/admin/users â€º should deny access to admin (Owner only route)

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

    [0m [90m 64 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${adminToken}`[39m)[33m;[39m
     [90m 65 |[39m
    [31m[1m>[22m[39m[90m 66 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m403[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 67 |[39m         })[33m;[39m
     [90m 68 |[39m
     [90m 69 |[39m         it([32m'should deny access to staff'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.toBe (tests/rbac.test.js:66:36)

PASS tests/two-factor.test.js (16.325 s)
  Two-Factor Authentication
    GET /api/auth/2fa/status
      âˆš should return isTwoFactorEnabled: false by default (395 ms)
      âˆš should return isTwoFactorEnabled: true after setup (716 ms)
      âˆš should require authentication (29 ms)
    POST /api/auth/2fa/setup
      âˆš should return QR code and secret (646 ms)
      âˆš should save secret to user without enabling 2FA (654 ms)
      âˆš should reject if 2FA is already enabled (672 ms)
      âˆš should require authentication (27 ms)
    POST /api/auth/2fa/setup/verify
      âˆš should enable 2FA with valid code (664 ms)
      âˆš should reject invalid code (690 ms)
      âˆš should reject if 2FA is already enabled (693 ms)
      âˆš should reject if setup was not initiated (299 ms)
      âˆš should reject non-6-digit code (680 ms)
    POST /api/auth/login (with 2FA)
      âˆš should return requiresTwoFactor when 2FA is enabled (912 ms)
      âˆš should return tokens normally when 2FA is not enabled (520 ms)
      âˆš should include isTwoFactorEnabled in login response when 2FA is off (524 ms)
    POST /api/auth/2fa/verify-login
      âˆš should complete login with valid 2FA code (913 ms)
      âˆš should reject invalid 2FA code (920 ms)
      âˆš should reject expired two-factor token (729 ms)
      âˆš should reject token with wrong purpose (704 ms)
      âˆš should reject completely invalid token (28 ms)
      âˆš should reject missing code (30 ms)
    POST /api/auth/2fa/disable
      âˆš should disable 2FA with valid code (680 ms)
      âˆš should reject invalid code (670 ms)
      âˆš should reject if 2FA is not enabled (287 ms)
      âˆš should allow normal login after disabling 2FA (927 ms)
      âˆš should require authentication (30 ms)
    Full 2FA lifecycle
      âˆš should support enable â†’ login with 2FA â†’ disable â†’ login without 2FA (1211 ms)

PASS tests/password-reset.test.js (8.876 s)
  Password Reset Flow
    POST /api/auth/forgot-password
      âˆš should return success for existing email (anti-enumeration) (412 ms)
      âˆš should return success for non-existing email (anti-enumeration) (287 ms)
      âˆš should create a password_reset token for existing user (306 ms)
      âˆš should not create a token for non-existing user (295 ms)
      âˆš should invalidate previous reset tokens when requesting a new one (324 ms)
      âˆš should reject invalid email format (287 ms)
      âˆš should reject missing email (280 ms)
    POST /api/auth/reset-password
      âˆš should reset password with valid token (566 ms)
      âˆš should allow login with new password after reset (804 ms)
      âˆš should reject login with old password after reset (799 ms)
      âˆš should revoke all existing refresh tokens (799 ms)
      âˆš should consume the reset token (545 ms)
      âˆš should reject already-used reset token (555 ms)
      âˆš should reject invalid token (338 ms)
      âˆš should reject expired token (312 ms)
      âˆš should reject mismatched passwords (298 ms)
      âˆš should reject password too short (304 ms)
      âˆš should reject missing token (302 ms)

PASS tests/auth.test.js (5.419 s)
  POST /api/auth/register
    âˆš should register a new user and return access + refresh tokens (366 ms)
  POST /api/auth/login
    âˆš should login and return access + refresh tokens (512 ms)
  POST /api/auth/refresh-token
    âˆš should refresh token pair with valid refresh token (297 ms)
    âˆš should reject invalid refresh token (282 ms)
    âˆš should reject reused (revoked) refresh token (300 ms)
  POST /api/auth/logout
    âˆš should revoke refresh token on logout (288 ms)
    âˆš should not allow refresh after logout (299 ms)
  PATCH /api/auth/profile
    âˆš should update user profile details (289 ms)
    âˆš should change password successfully (1012 ms)
    âˆš should reject password change with incorrect current password (528 ms)
    âˆš should reject password change if new passwords do not match (294 ms)

PASS tests/email-verification.test.js
  Email Verification
    POST /api/auth/register
      âˆš should return isEmailVerified: false on registration (374 ms)
      âˆš should create a verification token on registration (273 ms)
    POST /api/auth/login
      âˆš should return isEmailVerified in login response (517 ms)
      âˆš should return isEmailVerified: true after verification (517 ms)
    POST /api/auth/verify-email
      âˆš should verify email with valid token (304 ms)
      âˆš should reject invalid token (32 ms)
      âˆš should reject already-used token (331 ms)
      âˆš should reject expired token (290 ms)
      âˆš should reject empty token (27 ms)
    POST /api/auth/resend-verification
      âˆš should resend verification email for unverified user (294 ms)
      âˆš should reject if email is already verified (288 ms)
      âˆš should require authentication (30 ms)
  requireVerifiedEmail middleware
    âˆš should block unverified users from admin routes (301 ms)
    âˆš should allow verified users to access admin routes (290 ms)

(node:9896) [MONGOOSE] Warning: mongoose: the `new` option for `findOneAndUpdate()` and `findOneAndReplace()` is deprecated. Use `returnDocument: 'after'` instead.
(node:9896) [MONGOOSE] Warning: mongoose: the `new` option for `findOneAndUpdate()` and `findOneAndReplace()` is deprecated. Use `returnDocument: 'after'` instead.
(node:9896) [MONGOOSE] Warning: mongoose: the `new` option for `findOneAndUpdate()` and `findOneAndReplace()` is deprecated. Use `returnDocument: 'after'` instead.
PASS tests/phase2_completion.test.js
  Phase 2 Completion Verification
    Marketplace Hardening & Search
      âˆš should support search and category filtering in /products (673 ms)
      âˆš should allow editing and soft-deleting products (573 ms)
    Dependency Validation
      âˆš should reject purchase if dependencies are missing (557 ms)
    Tenant Lifecycle & Suspension
      âˆš should block API access for suspended tenants (544 ms)
      âˆš should export tenant data (Owner only) (547 ms)
    Usage Tracking
      âˆš should meter API calls via usageMiddleware (657 ms)

PASS tests/marketplace.test.js
  GET /api/marketplace/products
    âˆš should list products (empty initially) (427 ms)
  POST /api/marketplace/products
    âˆš should create a product (305 ms)
    âˆš should reject duplicate slug with 409 (313 ms)
    âˆš should reject missing required fields (Zod) (323 ms)
    âˆš should require auth (326 ms)
  POST /api/marketplace/purchase
    âˆš should require auth (328 ms)
    âˆš should require tenant context for role check (585 ms)
    âˆš should reject empty body (Zod) (321 ms)

PASS tests/audit.test.js
  Audit Logging Integration
    âˆš should create an audit log when inviting a user (497 ms)
    âˆš should return paginated audit logs (421 ms)
    âˆš should filter audit logs by action (330 ms)

PASS tests/tenant-provisioning.test.js
  deriveTenantDbUri
    âˆš should replace the DB name in a standard mongodb:// URI (2 ms)
    âˆš should replace the DB name in a URI with auth credentials (1 ms)
    âˆš should preserve query parameters (1 ms)
    âˆš should handle mongodb+srv:// URIs (1 ms)
    âˆš should handle URIs with no database name (1 ms)
    âˆš should handle URIs with no trailing slash and no DB name (1 ms)
  Tenant Database Provisioning (integration)
    âˆš should provision a tenant database and return a valid URI (42 ms)
    âˆš should drop a provisioned tenant database without error (69 ms)
  Tenant CRUD with provisioning
    âˆš should populate dbUri when creating a tenant (48 ms)
    âˆš dbUri should follow frame_tenant_{slug} naming convention (42 ms)
    âˆš should delete a tenant with a provisioned dbUri (78 ms)

PASS tests/provisioning.test.js
  Provisioning Engine
    âˆš should call onProvision hook and emit socket event on purchase (429 ms)
    âˆš should not fail purchase if onProvision hook fails (317 ms)

PASS tests/metrics.test.js
  Analytics & Metrics
    âˆš should create a metric record on heartbeat (35 ms)
    âˆš should retrieve historical metrics (21 ms)
    âˆš should retrieve fleet statistics (30 ms)

PASS tests/verification-token.test.js
  VerificationToken Model
    createToken()
      âˆš should create a token with correct fields (47 ms)
      âˆš should set expiry correctly (15 ms)
      âˆš should invalidate prior tokens of the same type (22 ms)
      âˆš should not invalidate tokens of different types (24 ms)
      âˆš should store metadata (9 ms)
    findValidToken()
      âˆš should find a valid unexpired token (13 ms)
      âˆš should not find an expired token (17 ms)
      âˆš should not find a used token (15 ms)
      âˆš should not find token with wrong type (14 ms)
      âˆš should return null for non-existent token (7 ms)
    consume()
      âˆš should set usedAt to current date (15 ms)

PASS tests/health.test.js
  Health Check
    GET /api/health
      âˆš should return 200 OK and health status (44 ms)

Test Suites: 3 failed, 12 passed, 15 total
Tests:       3 failed, 150 passed, 153 total
Snapshots:   0 total
Time:        71.707 s, estimated 74 s
Ran all test suites.
